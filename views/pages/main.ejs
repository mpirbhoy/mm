<% include ../partials/head %>

<body>

<% include ../partials/nav_logged_in %>

<!-- Left side of the Page -->
<div class="container-fluid">
    <div class="row">
        <!-- Search class menu & classes -->
        <div class="col-sm-3 col-md-3 sidebar">
            <div class="input-group input-group-md">
                <!-- Search Functionality with Select 2 Plugin -->
                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                <select class="select2 form-control" style="width: 100%"></select>
            </div>

            <!-- List of Classes -->
            <div class="list-group" style="margin-top: 20px">
                <form id="courses">
                </form>
            </div>
        </div>

        <!-- RIGHT SIDE OF THE PAGE -->
        <div class="col-sm-9 col-sm-offset-3 col-md-9 col-md-offset-3 main">
            <div class="col-lg-6">
                <div>
                    <div id='calendar'></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div>
                    <div id='calendar2'></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Initiate localStorage
        if (typeof(Storage) !== "undefined") {
            // Store
            localStorage.setItem("test", "test");
            // Retrieve
            console.log("Successful");
            localStorage.clear();
        } else {
            alert("Your browser does not support Web Storage.\n (data is lost when the browser is closed.)");
        }

        // Initiate search bar
        $(".select2").select2({
            placeholder: "Select courses",
            ajax: {
                url: "/allcourses",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term // search term
                    };
                },
                processResults: function (data, params) {
                    // parse the results into the format expected by Select2
                    // since we are using custom formatting functions we do not need to
                    // alter the remote JSON data
                    // http://stackoverflow.com/questions/31353259/select2-4-0-0-cant-select-results

                    return {
                        results: data
                    };
                },
                cache: true
            },
            escapeMarkup: function (markup) { return markup; }, // let the custom formatter work
            minimumInputLength: 0,
            templateResult: formatCourse,
            templateSelection: formatCourseSelection
        });


        function formatCourse (course) {
            if (course.loading) return course.text;
            var markup = "<div class='select2-result-repository clearfix'>" +
                    "<div class='select2-result-repository__title'>" + course.courseCode + " " + course.courseName + "</div></div>";
            return markup;
        }

        function formatCourseSelection (status) {
            return status.courseCode || status.text;
        }

        // Set eventListener for the searchbar
        var $eventSelect = $(".select2");
        $eventSelect.on("select2:select", function (e) { log("select2:select", e); });
        var courseCount = 1;


        // Add course to the sidebar
        function log (name, evt) {
            if (!evt) {
                var args = "{}";
            } else {
                var args = JSON.stringify(evt.params, function (key, value) {
                    if (value && value.nodeName) return "[DOM node]";
                    if (value instanceof $.Event) return "[$.Event]";
                    return value;
                });
            }

            var $email = $('#user-nav').attr('href');

            var courseCode = JSON.parse(args).data['courseCode'];
            var courseName = JSON.parse(args).data['courseName'];
            var courseInst = JSON.parse(args).data['instructors'];
            var coursePre = JSON.parse(args).data['prereqs'];
            var courseExc = JSON.parse(args).data['exclusions'];
            var section = JSON.parse(args).data['threads'];
            console.log(JSON.parse(args).data);

            $.ajax({
                type: "POST",
                url: "/course/" + courseCode,
                dataType: 'json',
                data: {courseCode: courseCode},
                success: function(data) {
                    if (data.status != 409) {
                        var msg = '<div class="panel panel-default">'+
                                '<button data-toggle="collapse" data-parent="#accordion" data-target="#collapse' + courseCount + '" class="list-group-item" value=' + courseCode + '><span id="close">x</span>' + courseCode + ': ' + courseName + '</button>' +
                                '<div id="collapse' + courseCount + '" class="panel-collapse collapse in"><div class="panel-body">';
                        msg += "Programming in a language such as Python. Elementary data types, lists, maps.  Program structure: control flow, functions, classes, objects, methods. Algorithms and problem solving. Searching, sorting, and complexity. Unit testing. No prior programming experience required.<br>";
                        if (coursePre) {
                            msg += "<span class='bold'> PRE: </span>" + coursePre + "<br>";
                        }
                        if (courseExc) {
                            msg += "<span class='bold'> EXC: </span>" + courseExc + "<br>";
                        }
                        msg += "<span class='bold'> INSTR: </span>" + courseInst + "<br>";
                        msg += "<div class='margin'><span class='bold'>SECTION: </span>";
                        section.forEach(function (lec) {
                            msg += "<div  class='section'>" + JSON.parse(lec).name + "</div>";
                            msg += "<div class='time' style='display:none;'>" + JSON.parse(lec).timings[0].day + "/" + JSON.parse(lec).timings[0].startTime + "/" + JSON.parse(lec).timings[0].endTime + "/" + JSON.parse(lec).timings[0].location + "</div>";
                            console.log(JSON.parse(lec).timings[0].day + "/" + JSON.parse(lec).timings[0].startTime + "/" + JSON.parse(lec).timings[0].endTime + "/" + JSON.parse(lec).timings[0].location);
                        });

                        msg += "<br><span class='bold'>MAIN: </span>LEC0501<br>"+
                                "<span class='bold'>SECONDARY: </span><div class='section'>LAB01</div><div class='section'>LAB02</div><div class='section'>LAB03</div><br>"+
                                "<span class='bold'>Catalog #:</span><br><br>" +
                                '<div class="progress" style="margin-top:5px"><div class="progress-bar" role="progressbar"aria-valuenow="33" aria-valuemin="0" aria-valuemax="100" style="width:40%"></div></div>';


                        msg += '</div>';
                        $('#courses').prepend(msg);
                        courseCount++;
                    }
                },
                fail: function() {
                }
            });
            $(".select2").val('').trigger('change');
        }

        var source = [];
        var sourceClicked = [];

//        $('body').on({
//            mouseenter: function(){
//                var $courseCode = $(this).closest('.panel').find('button').attr('value');
//                var $time = $(this).next().html().split('/'); //$time[0] = date, $time[1] = startTime, $time[2] = endTime, time[3] = location
//                source.push({
//                    id: $courseCode,
//                    title: $courseCode+'\n'+$time[3],
//                    start: $time[0] + 'T' + $time[1],
//                    end: $time[0] + 'T' + $time[2],
//                    color:'#4fd84a'
//                });
//
//                if (localStorage.getItem("data") === null) {
//                    $('#calendar').fullCalendar( 'addEventSource', source);
//                } else {
//                    var data = JSON.parse(localStorage.getItem("data"));
//                    data.forEach(function(val, i) {
//                        if (JSON.stringify(val) === JSON.stringify(source[source.length-1])) {
//
//                        } else {
//                            $('#calendar').fullCalendar( 'addEventSource', source);
//                        }
//                    });
//                }
//
//            },
//            mouseleave: function(){
//                $('#calendar').fullCalendar( 'removeEventSource', source);
//                source.pop();
//
//
//            }
//        }, '.section');

        // Add lecture session on calendar
        $('body').on('click', '.section', function(e) {
            var $courseCode = $(this).closest('.panel').find('button').attr('value');
            var $time = $(this).next().html().split('/'); //$time[0] = date, $time[1] = startTime, $time[2] = endTime, time[3] = location
            sourceClicked.push({
                id: $courseCode,
                title: $courseCode+'\n'+$time[3],
                start: $time[0] + 'T' + $time[1],
                end: $time[0] + 'T' + $time[2],
                color:'#4fd84a'
            });

            if (localStorage.getItem("data") === null) {
                localStorage["data"] = JSON.stringify(sourceClicked);
                $('#calendar').fullCalendar( 'addEventSource', sourceClicked);
                console.log('added');
            } else {
                var data = JSON.parse(localStorage.getItem("data"));
                console.log(data);
//                var index = data.indexOf(JSON.stringify(sourceClicked[sourceClicked.length-1]));
                data.forEach(function(val, i) {
                    if (val.id === sourceClicked[sourceClicked.length-1].id &&
                            val.start === sourceClicked[sourceClicked.length-1].start) {
                        data.splice(i, 1);
                    }
                });
                $('#calendar').fullCalendar( 'addEventSource', data);
                localStorage["data"] = JSON.stringify(data);
            }
        });



        // Load courses on reload
        //for (var i = 0; i < courses.length; i++) {
        //    $('#courses').prepend("<button type='submit' class='list-group-item' value=" + courses[i].courseCode + "><span id='close'>x</span>  " + courses[i].courseCode + ": " + courses[i].courseName + "</button>");
        //};
        //$('body').on('click', '.list-group-item', function(e) {
        //    e.preventDefault();
        //    var $this = $(this);
        //    if (!$this.hasClass('active')) {
        //        // remove all other active buttons
        //        $(".list-group-item").each(function () {$(this).removeClass('active')});
        //        $this.addClass('active');
        //        $('.suggested-ads').remove();
        //    }
        //});

        // Delete a selected course from the sidebar
        $('body').on('click', '#close', function(){
//            $(this).closest('button').remove();
            $form = $(this).closest('form');
            $button = $(this).closest('button');

            $.ajax({
                type: "DELETE",
                url: "/course/" + $(this).closest('button').attr('value'),
                success: function(data) {
                    window.location.reload();
                },
                fail: function() {
                }
            });
        })

        // Initiate fall calender
        $('#calendar').fullCalendar(
                {defaultView: 'agendaWeek',
                    columnFormat: 'ddd',
                    weekends: false,
                    header:false,
                    allDaySlot:false,
                    minTime: '08:00:00',
                    maxTime: '21:00:00',
                    slotDuration: '00:15:00',
                    slotLabelInterval: '01:00:00'
                });

        $('#calendar').fullCalendar('gotoDate', '2015-12-21');

        $('#calendar').fullCalendar( 'addEventSource', [
            {
                title: 'CSC108\nLEC0101',
                start: '2015-12-24T08:15:00',
                end: '2015-12-24T10:15:00'
            },
            {
                title: 'CSC108\nLEC0101',
                start: '2015-12-22T08:15:00',
                end: '2015-12-22T10:15:00'
            }
        ] );

        $('#calendar').fullCalendar( 'addEventSource', [
            {
                title: 'CSC343\nLEC0101',
                start: '2015-12-21T15:00:00',
                end: '2015-12-21T16:00:00',
                color:'#ff9b00'
            },
            {
                title: 'CSC343\nLEC0101',
                start: '2015-12-23T15:00:00',
                end: '2015-12-23T16:00:00',
                color:'#ff9b00'
            },
            {
                title: 'CSC343\nLEC0101',
                start: '2015-12-25T15:00:00',
                end: '2015-12-25T16:00:00',
                color:'#ff9b00'
            },
        ] );

        $('#calendar').fullCalendar( 'addEventSource', [
            {
                title: 'MAT301\nLEC0101',
                start: '2015-12-23T18:00:00',
                end: '2015-12-23T21:00:00',
                color:'#4fd84a'
            }
        ] );
        $('#calendar').fullCalendar('refetchEvents');


        $('#calendar').fullCalendar('option', 'height', 720);


        // Initiate winter calender
        $('#calendar2').fullCalendar(
                {defaultView: 'agendaWeek',
                    columnFormat: 'ddd',
                    weekends: false,
                    header:false,
                    allDaySlot:false,
                    minTime: '08:00:00',
                    maxTime: '21:00:00',
                    slotDuration: '00:15:00',
                    slotLabelInterval: '01:00:00'
                });

        $('#calendar2').fullCalendar('gotoDate', '2015-12-21');
        $('#calendar2').fullCalendar('option', 'height', 720);
    });
</script>
</body>